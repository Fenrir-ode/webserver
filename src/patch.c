#include <stdint.h>
#include <string.h>
#include "log.h"
#include "patch.h"

/* ECC utilities */
extern int ecc_verify(const uint8_t *sector);
extern void ecc_generate(uint8_t *sector);
extern void ecc_clear(uint8_t *sector);


void fad2msf_bcd(int32_t fad, uint8_t *msf);

static const unsigned char region_code[] = {'J', 'T', 'U', 'B', 'K', 'A', 'E', 'L'};

static const uint8_t region_strings[8][32] = {
    // Regions patchs
    {
        0xA0, 0x0E, 0x00, 0x09, 0x46, 0x6F, 0x72, 0x20, 0x4A, 0x41, 0x50, 0x41, 0x4E, 0x2E, 0x20, 0x20,
        0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20}, // J
    {
        0xA0, 0x0E, 0x00, 0x09, 0x46, 0x6F, 0x72, 0x20, 0x54, 0x41, 0x49, 0x57, 0x41, 0x4E, 0x20, 0x61,
        0x6E, 0x64, 0x20, 0x50, 0x48, 0x49, 0x4C, 0x49, 0x50, 0x49, 0x4E, 0x45, 0x53, 0x2E, 0x20, 0x20}, // T
    {
        0xA0, 0x0E, 0x00, 0x09, 0x46, 0x6F, 0x72, 0x20, 0x55, 0x53, 0x41, 0x20, 0x61, 0x6E, 0x64, 0x20,
        0x43, 0x41, 0x4E, 0x41, 0x44, 0x41, 0x2E, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20}, // U
    {
        0xA0, 0x0E, 0x00, 0x09, 0x46, 0x6F, 0x72, 0x20, 0x42, 0x52, 0x41, 0x5A, 0x49, 0x4C, 0x2E, 0x20,
        0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20}, // B
    {
        0xA0, 0x0E, 0x00, 0x09, 0x46, 0x6F, 0x72, 0x20, 0x4B, 0x4F, 0x52, 0x45, 0x41, 0x2E, 0x20, 0x20,
        0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20}, // K
    {
        0xA0, 0x0E, 0x00, 0x09, 0x46, 0x6F, 0x72, 0x20, 0x41, 0x53, 0x49, 0x41, 0x20, 0x50, 0x41, 0x4C,
        0x20, 0x61, 0x72, 0x65, 0x61, 0x2E, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20}, // A
    {
        0xA0, 0x0E, 0x00, 0x09, 0x46, 0x6F, 0x72, 0x20, 0x45, 0x55, 0x52, 0x4F, 0x50, 0x45, 0x2E, 0x20,
        0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20}, // E
    {
        0xA0, 0x0E, 0x00, 0x09, 0x46, 0x6F, 0x72, 0x20, 0x4C, 0x41, 0x54, 0x49, 0x4E, 0x20, 0x41, 0x4D,
        0x45, 0x52, 0x49, 0x43, 0x41, 0x2E, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20} // L
};

static const char *region_str[] = {
    "Japan",
    "Taiwan",
    "USA",
    "Brazil",
    "Korea",
    "Asia Pal",
    "Europe",
    "Latin America"};

void patch_region_0(uint8_t *sector, int region)
{
    log_debug("Patch region fad 150");
    sector[0x50] = region_code[region];
    ecc_generate(sector);
}

void patch_region_1(uint8_t *sector, int region)
{
    log_debug("Patch region fad 151");
    memcpy(sector + (0xF40 - 2352), region_strings[region], sizeof(region_strings[region]));
    ecc_generate(sector);
}
